<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,300' rel='stylesheet' type='text/css'>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style>
      #quarters-chart-flex {
        font-family:"Open Sans",sans-serif;
      }
      .chartTitle {
        font-weight: bold;
        fill: #242424;
        font-size: 16px;
        margin-top: 20px;
        margin-bottom:12px;
      }
      .backBar {
        fill: #F1F1F1;
      }
      .srBar {
        fill: #C31C45;
      }
      .srGameBar {
        fill: #4A4A4A;
      }
      .qLabels {
        font-weight: 600;
        font-size: 14px;
        fill: #FFFFFF;
      }
      .srLabels {
        font-weight: 600;
        font-size: 14px;
        fill: #242424;
      }
      .meanLine {
        fill: #FFFFFF;
        width: 3px;
        opacity: .4;
      }

    </style>
  </head>

  <body>
    <div id="quarters-chart-flex">
      <p class="chartTitle">Success Rate by Quarter</p>
      <script>
        var callbackError;
        var callbackData;
        d3.csv("https://couchux.github.io/BAMA-MSU_SRbyQuarter.csv",
          function(error, data) {
            data.forEach(function(d) {
              d.SuccessRate = +d.SuccessRate
              if (d.Quarter !== "Game") {
                d.Quarter = "Q" + + d.Quarter
              }
              else {
                d.Quarter = d.Quarter
              }
            });
          callbackError = error;
          callbackData = data;

          var chartContainerWidth = document.getElementById("quarters-chart-flex").offsetWidth;
          var barHeight = 36;
          var BarMarginMulti = 1.1;
          var barHeightMulti = barHeight * BarMarginMulti
          var bamaFilter = function(d) { return d.Team === "Alabama" }
          var gameFilter = function(d) { return d.Quarter === "Game" }
          var notGameFilter = function(d) { return d.Quarter !== "Game" }
          var percentFormat = d3.format(".0%")
          var maxSR = d3.max(callbackData, function(d) { return d.SuccessRate });
          var meanSR = d3.mean(callbackData, function(d) { return d.SuccessRate });
          var maxIndex = d3.max(callbackData, function(d,i) { return (i + 1) / 2 });
          var svgHeight =  maxIndex * barHeightMulti;
          var gameBarMargin = 0.75
          var svgContainer = d3.select("#quarters-chart-flex").append("svg")
                                                              .attr("width","100%")
                                                              .attr("height",svgHeight);
          var backBars = svgContainer.selectAll("rect").data(callbackData)
                                                   .enter()
                                                   .filter(bamaFilter)
                                                   .append("rect")
                                                   .attr("class","backBar");
          var srBars = svgContainer.selectAll("rect:not(.backBar)").data(callbackData)
                                                   .enter()
                                                   .filter(bamaFilter)
                                                   .append("rect")
                                                   .filter(notGameFilter)
                                                   .attr("class","srBar");
          var gameBarAttrs = svgContainer.selectAll("rect:not(.backBar)")
                                         .filter(bamaFilter)
                                         .filter(gameFilter)
                                         .attr("class","srGameBar");
          var backBarAttrs = svgContainer.selectAll(".backBar")
                                         .attr("width",chartContainerWidth)
                                         .attr("height",barHeight)
                                         .attr("y",function(d,i){ return i * barHeightMulti});
          var srBarAttrs = svgContainer.selectAll(".srBar, .srGameBar")
                                       .attr("width",function(d,i) {return d.SuccessRate / maxSR * chartContainerWidth * gameBarMargin})
                                       .attr("height",barHeight)
                                       .attr("y",function(d,i){ return i * barHeightMulti});
          var meanLine = svgContainer.append("rect")
                                     .attr("class","meanLine")
                                     .attr("x",meanSR / maxSR * chartContainerWidth * gameBarMargin)
                                     .attr("height",svgHeight);
          var qLabels = svgContainer.selectAll("text").data(callbackData)
                                    .enter()
                                    .filter(bamaFilter)
                                    .append("text")
                                    .text(function(d) { return d.Quarter })
                                    .attr("class","qLabels");
          var qLabelsAttrs = svgContainer.selectAll(".qLabels")
                                         .attr("y",function(d,i) { return i * barHeightMulti + (barHeightMulti * .58 ) })
                                         .attr("x","10")
          var srLabels = svgContainer.selectAll("text:not(.qLabels)").data(callbackData)
                                     .enter()
                                     .filter(bamaFilter)
                                     .append("text")
                                     .text(function(d) { return percentFormat(d.SuccessRate) })
                                     .attr("class","srLabels");
          var srLabelsAttrs = svgContainer.selectAll(".srLabels")
                                          .attr("y",function(d,i) { return i * barHeightMulti + (barHeightMulti * .58 ) })
                                          .attr("x",chartContainerWidth - 10)
                                          .attr("text-anchor","end")



          });
      </script>
    </div>
  </body>

</html>
