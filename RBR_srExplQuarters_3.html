<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,300' rel='stylesheet' type='text/css'>
<link href='qsr.css' rel='stylesheet' type='text/css'>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
<div id="qsr-charts-container">
<script>

/* select what csv should be run */
var csv_url = "SrExp_Quarters.csv"

/* run the whole chart function */

qsrChart(csv_url, "Alabama", "1"); //the latter part doesn't do anything, but I'd like to control the team from here
qsrChart(csv_url, "Michigan State", "2");

/* tie chart colors to team names */
var teamColors = {
  "Alabama": "#C31C45",
  "Michigan State": "#1A7A64" // dark version was "#205649"
}
    gameColor = "#4A4A4A"

teamColor = function(team_name) {
  return teamColors[team_name]
};

/* defining the main chart functions */
function qsrChart(data_url, which_team, what_order) {
  d3.csv(data_url, csv_response.bind(null, which_team).bind(null, what_order))
}

function csv_response(which_team, what_order, error, data) {
  if (error) {
    console.error(error)
  }
  else {
    console.log("data loaded")
    qsrData = data.filter(function(row){
      return row.Team == which_team  //try to Filter/reformat ("Transform") outside of data pull
    })
    data.forEach(function(d) {
      d.SuccessRate = +d.SuccessRate
      if (d.Quarter !== "Game") {
        d.Quarter = "Q" + +d.Quarter
      }
      else {
        d.Quarter = d.Quarter
      }
    })

    render_chart(which_team, what_order)
  }
}

/* Some prep for building the d3 chart */
var containerWidth = document.getElementById("qsr-charts-container").offsetWidth

function chartWidthFn(containerWidth) {
  if (containerWidth <= 500) {
    return containerWidth
    }
  else {
    return containerWidth / 2 - qsrMarginRight()
    }
}

/* why isn't this function working? */
function qsrMarginRight(containerWidth) {
  if (containerWidth <= 500) {
    return 0
    }
  else {
    return 16
    }
}

function render_chart(which_team, what_order) {

var qsrChartName = "qsr-chart"

function selectChartClass() {
  return "." + qsrChartName + ".chart" + what_order
}

function defineChartClass() {
  return qsrChartName + " chart" + what_order
}

var layout = {
  barHeight: 32,
  barMarginBoost: 1.1,
  srWidthScale: 0.8,
  leagueSR: 0.42, //update this peridically for NCAA Success Rate averages
  leagueSRwidth: 3,
  qLabelX: 9,
  labelYpc: 0.58,
}

var chartWidth = chartWidthFn(containerWidth)
    barHeightMulti = layout.barHeight * layout.barMarginBoost
    labelYadj = barHeightMulti * layout.labelYpc
    maxIndex = d3.max(qsrData, function(d,i) { return (i + 1) });
    maxSR = d3.max(qsrData, function(d,i) { return d.SuccessRate })
    totalMaxSR = .47 // !!need to set this in an automated way by filtering outside of data pull, e.g., on render
    svgHeight = maxIndex * barHeightMulti
    leagueSRx = layout.leagueSR / totalMaxSR * chartWidth * layout.srWidthScale - layout.leagueSRwidth / 2
    srBarWidth = function(d,i) {
      return d.SuccessRate / totalMaxSR * chartWidth * layout.srWidthScale
    }
    barY = function(d,i) {
      return i * barHeightMulti
    }
    labelY = function(d,i) {
      return i * barHeightMulti + labelYadj
    }
    srBarColor = function(d,i) {
      if ( d.Quarter === "Game") {
        return gameColor
      }
      else {
        return teamColor(d.Team)
      }
    }
    returnQ = function(d,i) {
      return d.Quarter
    }
    srPercent = function(d) {
      return  format.percent(d.SuccessRate)
    }
    marginRightPx = function() {
      return qsrMarginRight() + "px"
    }

var format = {
  percent: d3.format(".0%")
}

/* actually building the chart in d3 */

var teamChart = d3.select("#qsr-charts-container")
      .append("div")
      .attr("class",defineChartClass())
      .style("margin-right",marginRightPx())

    teamTitle = d3.select(selectChartClass())
      .append("p")
      .text(which_team)
      .style("color",teamColor(which_team))
      .attr("class","teamTitle")

    svg = d3.select(selectChartClass())
      .append("svg")
      .attr("class","svgChart")
      .attr("width",chartWidth)
      .attr("height",svgHeight)

    backBars = svg.selectAll(".backBar").data(qsrData).enter()
      .append("rect")
      .attr("class","backBar")
      .attr("width",chartWidth)
      .attr("height",layout.barHeight)
      .attr("y",barY)

    srBars = svg.selectAll(".srBar").data(qsrData).enter()
      .append("rect")
      .attr("class","backBar")
      .attr("width",srBarWidth)
      .attr("height",layout.barHeight)
      .attr("y",barY)
      .style("fill",srBarColor)

    expBars = svg.selectAll(".anchors").data(qsrData).enter()
      .append("rect")
      .attr("class","anchors")
      .attr("width",srBarWidth)
      .attr("height",layout.barHeight)
      .attr("y",barY)

    qLabels = svg.selectAll(".qLabels").data(qsrData).enter()
      .append("text")
      .text(returnQ)
      .attr("class","qLabels")
      .attr("x",layout.qLabelX)
      .attr("y",labelY)

    srLabels = svg.selectAll(".srLabels").data(qsrData).enter()
      .append("text")
      .text(srPercent)
      .attr("class","srLabels")
      .attr("text-anchor","end")
      .attr("x", chartWidth - layout.qLabelX)
      .attr("y",labelY)

    leagueSRline = svg.append("rect")
      .attr("class","leagueSRline")
      .attr("height",svgHeight)
      .attr("width",layout.leagueSRwidth)
      .attr("x",leagueSRx)


} //end of building chart in d3


</script>
</div>
</body>
</html>
